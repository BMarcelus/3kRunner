<canvas width=780 height=450 style="height:98%">
<script>
//Copyright Brian Dizon 2018
try{A=webkitAudioContext}catch(e){A=AudioContext}A=new A();
P=(f)=>{
  o=A.createOscillator();
  m=A.currentTime;o.start();
  o.stop(m+.07);
  o.type="square";
  o.frequency.setValueAtTime(f,m+.01);
  f=A.createGain();
  f.connect(A.destination);
  f.gain.value=.03;o.connect(f);
};
c=document.querySelector('canvas').getContext('2d');
c.font="20px Arial";
I=X=200;
Y=J=M=100;
L=$=v=k=t=f=S=V=h=x=G=F=N=D=Z=0;
T=g=Q=1;
p=[];
r=Math.random;y=300;B="#eef";W='#000';E=.7;
e=[];
//set the color of the canvas
C=L=>{c.fillStyle=L};
c.T=c.fillText;
c.R=c.fillRect;
//process platforms
q=(i,j,w,H,e)=>{
  C(B);
  //game is running and colliding with player and not a +score
  w-2&&t&&i+w>=X&&i<X+30&&j+H>=Y+h&&j<=Y+30&&(
    w-20?
    //not a heart
      v>=0&&Y<=j?
      //landing on it
        (
          //put character on platform
          Y=j-29,
          Z-5||(e[1]+=v,Y+=v),
          //set grounded
          //if boing, boing
          H-27?
            v=g=0:
            P(Y,v=Z-3?-12:-15,k=0,e[1]+=9),
          //make thumper lower
          //speed boost
          H-18||P(V=15)
        ):
      //running into it
      //is wall
        w-50||(Z-2?
          K():
          // make pinky bounce
          P(V-=9,e[1]-=4)):
    //heart
      (
        //add to score
        f+=30+10*Z,
        //transform into +score
        e[2]=2,
        //play a note
        P(880+440*(1-E)),
        //prepare to play note in 3 frames
        G=F+3,
        //increase probability of heart
        E*=.99)
      );
  //draws
  w-2?
    w-20?
  // platform
      c.R(i,j,w,H,w-50||Z-2||C('#a0a')):
  // heart
      c.T('<3',i,j+20,C(R)):
  // +score
    (c.T('+'+(30+10*Z),i,j,C(R)),e[1]-=1,e[0]+=V/2);
  //boost
  H-18||c.T('>>>>>>>>',i,j);
  H-27||c.R(i-4,j,w+8,H/2)
};
s=j=>{
  // Z=1
  // do the Frame count, cycle characters if held after death screen animation
  ++F*k*D<50||F%60||(Z++,Z%=Q);
  // lerp player to starting position during death screen
  D*F>50?Y+=(M-Y)/9:0;
  // set the background color / clear canvas
  C(D?F>1?W+'3':'#f005':W);  
  c.R(0,0,1e3,450);
  //HUD
  C(B);
  c.T('tap:FALL hold:CROUCH release:JUMP',200,20);
  c.R(20,70,660,2),
  c.R(20,52,L/3e4*660,20),
  c.R(20,81,($+f)/I*160,20),
  c.R(20,99,160,2),
  c.T(f,M,50);
  c.T($+f,M,20);
  // player is not grounded if v > 5
  g=g||v>5;
  //apply gravity
  v+=Z-3?.3:.5;
  Z-4?0:v+=Math.cos(F/4)*g/2;
  // make pinky float
  v=Z*k*g-2||v<0?v:1;
  // Z-4?0:v=4-8*k
  // apply y velocity if game is running
  t?0:v=0;
  Y+=v;
  // set crouching
  m=!D*k;
  // set character height
  h+=m*7-h/2;
  // lerp character x velocity depending on character
  V+=!D*([4,4,3+6*g,8,6,9+f/3e3*9][Z]-V)/20;
  // make thumper thump
  V=Z-5||!m?V:0;
  // Jeff
  z=Z-4?V:V+v/2;
  // z=V-(k||Z-4?0:-vy);
  L+=z*t;
  // run the platforms
  x-=z;
  p.forEach(e=>{
    //apply platform movements, and call q
    q(e[0]-=z,e[1]+Math.sin(e[0]/M)*9,e[2],e[3],e)
  });
// spawn new platforms
  //add a platform to p
  l=a=>{
    p.push(a);
    //add a heart above the platform with probability (1-E-.1)
    r()>E+.1&&p.push([x+r()*79,y-15-r()*120,20,30]);
  };
  // Z=3;
  // j=e=>Math.random()>.5?0:1;
  // j=e=>y>250?1:0;
  // j=r;
  //create a regular platform or boost platform
  u=d=>{
    d-2?0:y+=M*r();
    y=y<150?150:y>400?400:y;
    l([x+=M,y,M,9+d*9,d-1?0:x+=M,d-2?0:y-=M*r()])
  };
// if the last spawned platform is now in view
  x<1e3&&(e=r()>.5?0:Math.floor(r()*L/1e4)%3,
    !t||r()<.1?
      //spawn three in a row
      (u(0),u(L>2e3?L>4e3?2:1:0)):
      r()<.1&&L>1e3?
      //spawn wall
        (l([x+=200,y-=120,50,M],1),l([x-M,y+=120,250,10]),x+=50,u(0)):
      // randomly modify platform height
      // bound platform height to [150,400]
        y+=(.5-r())*190,
    //spawn regular platform at random x distance
    u(e,x+=r()*186)
  );
//set color based on character
  C(R=["#d26","#2a7","#f2f",'#0af',"#62d","#666"][Z]);
//set hat/hair based on character
  c.T(['M','▮▮','oöo','=>>','>FF','[█]'][Z],X-3-v/4,Y+10+h);
//draw character
  c.R(X-v/4,Y+h,30+Z+v/2,30-h);
//draw jump puffs
//2-10 frames after jumping
  F<10&&F>2&&c.T(`Ɛ>${' '.repeat(F-2)}<3`,X+15-F*V,J);
//draw crown if this character has won
  e[Z]&&c.T(' ♕',X,Y+m*14,C('#db0'));
//remove the oldest platform if it is off screen
  p[0][0]<-p[0][2]&&p.shift();
//draw face
    C(W);
  //select mouth based on character
    z="-.v wñ"[Z];
    c.T(k||D?`>${z}<`:`^${z}^`,X+5,Y+20+v+h/2);
//kill the player if they fall off screen
  Y>450&&(Y=420,K());
//bound player to the ceiling
  Y<0?Y=0:0;
  // Y<0&&(Y=0,Z-4||K());
// display death screen
  D?
    (m=260+999/F,C(B),c.R(m-25,45,230,250),C(W),c.R(m-20,50,220,240),C(B),
    c.T(`<3's: ${f}!`,m,90),
    F>40&&c.T(`Best: ${S=f>S?f:S}`,m,120),
    c.R(m,258,160,2),
    c.R(m,240,f/I*160,20),
    c.T(Q-6?'new char at '+I:e[Z]?'YAY u win':'final goal 3k',m,280),
    N&&F%25>10&&c.T('*New Char Unlocked!',m,150),
    Q-1&&c.T('hold to change char',m,200),
    F%7||F>10&&F<44&&((e[Z]||N)?P(880+F*F):P(880-F*F))):
//if alive and score > 3000, set this character to win
  f<3e3?0:e[Z]=1;
// play the delayed <3 pickup sound
  F==G&&(P(1200),G=0);
// if money exceeds current goal, pay money to unlock character
// and set new goal
  $+f<I||Q>5?0:(Z=N=Q++,$-=I,K(),I*=2);
  T&&window.requestAnimationFrame(s);
};
//kill player
K=e=>{
  V=t=v=F=0,g=D=1,P(220);
};
a=e=>{
  e.metaKey||e.preventDefault();
  //set the puff location
  J=Y+20;
  //make sure it is a new keypress
  k?0:
    D?
      //if dead, reset counter to do character cycle
      F<50||(F=60):
      //otherwise, crouch
      P(550-Y,F=t=k=1,v=10);
  k=1;
};
b=e=>{
  D?
    //if dead, if after death screen animation, start the game
    F<50||(N||($+=f,L=f=0),N=D=0,Y=M,E=.7):
    k?g?
    // in the air
      v=10*t:
    // on the ground
      (
        //set puff location
        J=Y+20,
        //jump
        v=-10,
        //make froggy zoom
        Z-1||(V=10),
        //add to score
        // f+=5*Q,
        //set airborn and frame counter
        g=F=1,
        //play tone based on height
        P(880-Y)
      ):0;
k=0;
};
w=addEventListener.bind(window);
w('keydown',a);
w('keyup',b);
w('touchstart',a,{passive:false});
w('touchend',b);
s();
</script>